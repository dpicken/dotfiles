#!/usr/bin/python -u

import contextlib
import os
import subprocess

PROJECT_CONTAINER_PATHS = os.environ['PROJECT_CONTAINER_PATHS'].split(':')

@contextlib.contextmanager
def scoped_cd(directory):
    previous_directory = os.getcwd()
    try:
        os.chdir(directory)
        yield
    finally:
        os.chdir(previous_directory)

def execute_command_line(command_line):
    print command_line
    subprocess.check_call(command_line, shell=True)

def integrate(project_path):
    print "Integrating " + project_path
    with scoped_cd(project_path):
        execute_command_line('git-integrate')

def build(project_path):
    with scoped_cd(project_path):
        if os.path.isfile(project_path + "/.pir_build") == True:
            print "Building " + project_path
            execute_command_line("./.pir_build")
        elif os.path.isfile(project_path + '/Makefile') == True:
            print "Building " + project_path
            execute_command_line('make $MAKE_OPTIONS clean')
            execute_command_line('make $MAKE_OPTIONS')
        elif os.path.isfile(project_path + '/pom.xml') == True:
            print "Building " + project_path
            execute_command_line('mvn --quiet clean install $MVN_OPTIONS')
        execute_command_line('mkctags .tags')

def is_project(project_path):
    if os.path.isdir(project_path) != True:
        return False
    if os.path.isdir(project_path + '/.git') != True:
        return False
    if os.path.isfile(project_path + '/.pir_skip') == True:
        return False
    return True

def get_project_paths(project_container_path):
    with scoped_cd(project_container_path):
        project_paths = []
        for file in os.listdir('.'):
            project_path = os.getcwd() + '/' + file
            if is_project(project_path) != True:
                continue
            project_paths.append(project_path)
    return project_paths

project_paths = []
for project_container_path in PROJECT_CONTAINER_PATHS:
    project_paths += get_project_paths(project_container_path)

integrate_failures = []
for project_path in project_paths:
    try:
        integrate(project_path)
    except KeyboardInterrupt:
        raise
    except:
        integrate_failures.append(project_path)

build_failures = []
for project_path in project_paths:
    try:
        build(project_path)
    except KeyboardInterrupt:
        raise
    except:
        build_failures.append(project_path)

if integrate_failures or build_failures:
    if integrate_failures:
        print "Failed to integrate:", ", ".join(integrate_failures)
    if build_failures:
        print "Failed to build:", ", ".join(build_failures)
    exit(1)
